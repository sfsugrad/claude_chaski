name: E2E Tests

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: chaski
          POSTGRES_PASSWORD: chaski
          POSTGRES_DB: chaski_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgresql://chaski:chaski@localhost:5432/chaski_test
      SECRET_KEY: test-secret-key-for-ci
      FRONTEND_URL: http://localhost:3000
      NEXT_PUBLIC_API_URL: http://localhost:8000
      MAIL_USERNAME: test@example.com
      MAIL_PASSWORD: testpassword
      MAIL_FROM: noreply@chaski.com
      MAIL_PORT: 587
      MAIL_SERVER: smtp.test.com
      MAIL_FROM_NAME: Chaski
      MAIL_STARTTLS: "True"
      MAIL_SSL_TLS: "False"
      USE_CREDENTIALS: "True"
      VALIDATE_CERTS: "False"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install backend dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: frontend
        run: npx playwright install chromium --with-deps

      - name: Set up database
        working-directory: backend
        run: |
          python -c "
          from app.database import engine
          from app.models.base import Base
          from app.models.user import User
          from app.models.package import Package, CourierRoute
          from app.models.notification import Notification
          from app.models.rating import Rating
          from app.models.message import Message
          from app.models.audit_log import AuditLog
          from app.models.bid import CourierBid
          Base.metadata.create_all(bind=engine)
          "

      - name: Load test data
        working-directory: backend
        run: python -m test_data.load_test_data

      - name: Start backend server
        working-directory: backend
        run: |
          uvicorn main:app --host 0.0.0.0 --port 8000 &
          sleep 5
          curl -f http://localhost:8000/api/health || exit 1

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Run E2E tests
        working-directory: frontend
        run: npm run test:e2e
        env:
          PLAYWRIGHT_BASE_URL: http://localhost:3000

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 7

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: frontend/test-results/
          retention-days: 7
