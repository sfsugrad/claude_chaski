<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route-Package Matching Feature - Chaski Documentation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        header h1 {
            font-size: 2.5rem;
            color: #1a1a2e;
            margin-bottom: 10px;
        }

        header p {
            color: #666;
            font-size: 1.1rem;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-right: 8px;
        }

        .badge-primary { background: #667eea; color: white; }
        .badge-success { background: #10b981; color: white; }
        .badge-warning { background: #f59e0b; color: white; }
        .badge-danger { background: #ef4444; color: white; }
        .badge-info { background: #3b82f6; color: white; }

        section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        section h2 {
            color: #1a1a2e;
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        section h3 {
            color: #374151;
            font-size: 1.2rem;
            margin: 20px 0 10px 0;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .feature-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            padding: 20px;
            transition: transform 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
        }

        .feature-card h4 {
            color: #1a1a2e;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .feature-card h4 .icon {
            font-size: 1.5rem;
        }

        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;
            font-size: 0.9rem;
            margin: 15px 0;
        }

        .code-block .comment { color: #6a9955; }
        .code-block .keyword { color: #569cd6; }
        .code-block .string { color: #ce9178; }
        .code-block .number { color: #b5cea8; }
        .code-block .function { color: #dcdcaa; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f9fafb;
        }

        .flow-diagram {
            background: #f8fafc;
            border-radius: 12px;
            padding: 30px;
            margin: 20px 0;
        }

        .flow-steps {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }

        .flow-step {
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px 20px;
            text-align: center;
            min-width: 150px;
        }

        .flow-step.active {
            background: #667eea;
            color: white;
        }

        .flow-arrow {
            font-size: 1.5rem;
            color: #667eea;
        }

        .algorithm-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }

        .algorithm-box h4 {
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .algorithm-box ol {
            margin-left: 20px;
        }

        .algorithm-box li {
            margin-bottom: 10px;
        }

        .file-tree {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
        }

        .file-tree .folder { color: #dcdcaa; }
        .file-tree .file { color: #9cdcfe; }
        .file-tree .desc { color: #6a9955; }

        .formula-box {
            background: #f0f9ff;
            border-left: 4px solid #3b82f6;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .formula-box code {
            background: white;
            padding: 10px 15px;
            display: block;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            margin-top: 10px;
        }

        .config-table {
            background: #fefce8;
            border-radius: 8px;
            overflow: hidden;
        }

        .config-table th {
            background: #ca8a04;
        }

        .workflow-example {
            background: #f0fdf4;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }

        .workflow-example h4 {
            color: #166534;
            margin-bottom: 15px;
        }

        .api-method {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.75rem;
            margin-right: 8px;
        }

        .api-get { background: #10b981; color: white; }
        .api-post { background: #3b82f6; color: white; }
        .api-put { background: #f59e0b; color: white; }
        .api-delete { background: #ef4444; color: white; }

        .deprecated {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .note {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .note strong {
            color: #92400e;
        }

        footer {
            text-align: center;
            padding: 30px;
            color: white;
        }

        footer a {
            color: white;
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8rem;
            }

            .flow-steps {
                flex-direction: column;
            }

            .flow-arrow {
                transform: rotate(90deg);
            }
        }

        @media print {
            body {
                background: white;
            }

            section, header {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Route-Package Matching Feature</h1>
            <p>Comprehensive documentation for Chaski's geospatial matching system</p>
            <div style="margin-top: 15px;">
                <span class="badge badge-primary">Geospatial</span>
                <span class="badge badge-success">Haversine</span>
                <span class="badge badge-info">Shapely</span>
                <span class="badge badge-warning">Real-time</span>
            </div>
        </header>

        <section>
            <h2>Overview</h2>
            <p>The Route-Package Matching system is the core algorithm that connects package senders with couriers traveling along compatible routes. It uses geospatial calculations to find packages whose pickup and dropoff locations are within acceptable deviation from a courier's planned route.</p>

            <div class="feature-grid">
                <div class="feature-card">
                    <h4><span class="icon">üó∫Ô∏è</span> Geospatial Matching</h4>
                    <p>Uses Shapely LineString geometry to represent routes and calculate perpendicular distances from package locations.</p>
                </div>
                <div class="feature-card">
                    <h4><span class="icon">üìè</span> Haversine Formula</h4>
                    <p>Calculates great-circle distances on Earth's surface for accurate distance measurements in kilometers.</p>
                </div>
                <div class="feature-card">
                    <h4><span class="icon">üéØ</span> Detour Optimization</h4>
                    <p>Sorts matched packages by estimated detour distance, showing couriers the most efficient options first.</p>
                </div>
                <div class="feature-card">
                    <h4><span class="icon">üîî</span> Automatic Notifications</h4>
                    <p>Background job notifies couriers when new packages match their active routes.</p>
                </div>
            </div>
        </section>

        <section>
            <h2>Matching Algorithm</h2>

            <div class="algorithm-box">
                <h4>How Matching Works - Step by Step</h4>
                <ol>
                    <li><strong>Create Route Geometry:</strong> Convert courier route start/end coordinates into a Shapely LineString</li>
                    <li><strong>Query Packages:</strong> Fetch all packages with status <code>OPEN_FOR_BIDS</code> and <code>is_active=True</code></li>
                    <li><strong>Calculate Distances:</strong> For each package, find nearest points on route line to pickup and dropoff locations</li>
                    <li><strong>Filter by Deviation:</strong> Include package only if max distance ‚â§ route's <code>max_deviation_km</code></li>
                    <li><strong>Calculate Detour:</strong> Compute total detour cost for matched packages</li>
                    <li><strong>Sort Results:</strong> Order by <code>estimated_detour_km</code> (shortest first)</li>
                </ol>
            </div>

            <h3>Distance Calculation</h3>
            <div class="formula-box">
                <strong>Distance from Route (filtering criterion):</strong>
                <code>distance_from_route_km = MAX(pickup_to_route_distance, dropoff_to_route_distance)</code>
            </div>

            <div class="formula-box">
                <strong>Estimated Detour (sorting criterion):</strong>
                <code>detour = haversine(pickup, nearest_point_on_route) + haversine(pickup, dropoff) + haversine(dropoff, nearest_point_on_route)</code>
            </div>

            <h3>Core Algorithm Code</h3>
            <div class="code-block">
<span class="keyword">from</span> shapely.geometry <span class="keyword">import</span> Point, LineString
<span class="keyword">from</span> shapely.ops <span class="keyword">import</span> nearest_points
<span class="keyword">from</span> app.utils.geo <span class="keyword">import</span> haversine_distance

<span class="keyword">def</span> <span class="function">find_matching_packages</span>(route, packages):
    <span class="comment"># Create route line geometry</span>
    route_line = LineString([
        (route.start_lng, route.start_lat),
        (route.end_lng, route.end_lat)
    ])

    matched = []
    <span class="keyword">for</span> pkg <span class="keyword">in</span> packages:
        <span class="comment"># Find nearest point on route to pickup</span>
        pickup_point = Point(pkg.pickup_lng, pkg.pickup_lat)
        nearest_to_pickup = nearest_points(route_line, pickup_point)[<span class="number">0</span>]
        pickup_distance = haversine_distance(
            pkg.pickup_lat, pkg.pickup_lng,
            nearest_to_pickup.y, nearest_to_pickup.x
        )

        <span class="comment"># Find nearest point on route to dropoff</span>
        dropoff_point = Point(pkg.dropoff_lng, pkg.dropoff_lat)
        nearest_to_dropoff = nearest_points(route_line, dropoff_point)[<span class="number">0</span>]
        dropoff_distance = haversine_distance(
            pkg.dropoff_lat, pkg.dropoff_lng,
            nearest_to_dropoff.y, nearest_to_dropoff.x
        )

        <span class="comment"># Check if within deviation limit</span>
        max_distance = max(pickup_distance, dropoff_distance)
        <span class="keyword">if</span> max_distance <= route.max_deviation_km:
            matched.append({
                <span class="string">'package'</span>: pkg,
                <span class="string">'distance_from_route_km'</span>: max_distance,
                <span class="string">'estimated_detour_km'</span>: calculate_detour(...)
            })

    <span class="comment"># Sort by detour (best first)</span>
    <span class="keyword">return</span> sorted(matched, key=<span class="keyword">lambda</span> x: x[<span class="string">'estimated_detour_km'</span>])
            </div>
        </section>

        <section>
            <h2>API Endpoints</h2>

            <h3>Matching Endpoints</h3>
            <table>
                <thead>
                    <tr>
                        <th>Method</th>
                        <th>Endpoint</th>
                        <th>Description</th>
                        <th>Auth</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="api-method api-get">GET</span></td>
                        <td><code>/api/matching/packages-along-route/{route_id}</code></td>
                        <td>Find all matching packages for a route</td>
                        <td>Courier+</td>
                    </tr>
                    <tr>
                        <td><span class="api-method api-get">GET</span></td>
                        <td><code>/api/matching/optimized-route/{route_id}</code></td>
                        <td>Get package delivery stops ordered by position</td>
                        <td>Courier+</td>
                    </tr>
                    <tr class="deprecated">
                        <td><span class="api-method api-post">POST</span></td>
                        <td><code>/api/matching/accept-package/{package_id}</code></td>
                        <td>DEPRECATED - replaced by bidding system</td>
                        <td>-</td>
                    </tr>
                    <tr class="deprecated">
                        <td><span class="api-method api-post">POST</span></td>
                        <td><code>/api/matching/decline-package/{package_id}</code></td>
                        <td>DEPRECATED - replaced by bidding system</td>
                        <td>-</td>
                    </tr>
                </tbody>
            </table>

            <h3>Route Management Endpoints</h3>
            <table>
                <thead>
                    <tr>
                        <th>Method</th>
                        <th>Endpoint</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="api-method api-post">POST</span></td>
                        <td><code>/api/couriers/routes</code></td>
                        <td>Create new route (triggers match notification)</td>
                    </tr>
                    <tr>
                        <td><span class="api-method api-get">GET</span></td>
                        <td><code>/api/couriers/routes</code></td>
                        <td>List all courier routes</td>
                    </tr>
                    <tr>
                        <td><span class="api-method api-get">GET</span></td>
                        <td><code>/api/couriers/routes/{id}</code></td>
                        <td>Get route details</td>
                    </tr>
                    <tr>
                        <td><span class="api-method api-put">PUT</span></td>
                        <td><code>/api/couriers/routes/{id}</code></td>
                        <td>Update route details</td>
                    </tr>
                    <tr>
                        <td><span class="api-method api-delete">DELETE</span></td>
                        <td><code>/api/couriers/routes/{id}</code></td>
                        <td>Delete route</td>
                    </tr>
                    <tr>
                        <td><span class="api-method api-put">PUT</span></td>
                        <td><code>/api/couriers/routes/{id}/activate</code></td>
                        <td>Activate route</td>
                    </tr>
                </tbody>
            </table>

            <h3>Response Example</h3>
            <div class="code-block">
<span class="comment">// GET /api/matching/packages-along-route/1</span>
{
  <span class="string">"matched_packages"</span>: [
    {
      <span class="string">"package_id"</span>: <span class="number">15</span>,
      <span class="string">"tracking_id"</span>: <span class="string">"CHK-ABC123"</span>,
      <span class="string">"description"</span>: <span class="string">"Electronics package"</span>,
      <span class="string">"size"</span>: <span class="string">"medium"</span>,
      <span class="string">"weight_kg"</span>: <span class="number">2.5</span>,
      <span class="string">"pickup_address"</span>: <span class="string">"123 Main St, Palo Alto, CA"</span>,
      <span class="string">"pickup_lat"</span>: <span class="number">37.4419</span>,
      <span class="string">"pickup_lng"</span>: <span class="number">-122.1430</span>,
      <span class="string">"dropoff_address"</span>: <span class="string">"456 Tech Blvd, Mountain View, CA"</span>,
      <span class="string">"dropoff_lat"</span>: <span class="number">37.3861</span>,
      <span class="string">"dropoff_lng"</span>: <span class="number">-122.0839</span>,
      <span class="string">"price"</span>: <span class="number">25.00</span>,
      <span class="string">"distance_from_route_km"</span>: <span class="number">3.2</span>,
      <span class="string">"estimated_detour_km"</span>: <span class="number">8.5</span>,
      <span class="string">"pickup_contact_name"</span>: <span class="string">"John Sender"</span>,
      <span class="string">"pickup_contact_phone"</span>: <span class="string">"+15551234567"</span>
    }
  ]
}
            </div>
        </section>

        <section>
            <h2>User Flow</h2>

            <div class="flow-diagram">
                <div class="flow-steps">
                    <div class="flow-step active">
                        <strong>1. Create Route</strong>
                        <br><small>/courier/routes/create</small>
                    </div>
                    <span class="flow-arrow">‚Üí</span>
                    <div class="flow-step">
                        <strong>2. Auto-Match</strong>
                        <br><small>Background job</small>
                    </div>
                    <span class="flow-arrow">‚Üí</span>
                    <div class="flow-step">
                        <strong>3. View Matches</strong>
                        <br><small>/courier/routes/[id]/matches</small>
                    </div>
                    <span class="flow-arrow">‚Üí</span>
                    <div class="flow-step">
                        <strong>4. Place Bid</strong>
                        <br><small>BidOptionsModal</small>
                    </div>
                    <span class="flow-arrow">‚Üí</span>
                    <div class="flow-step">
                        <strong>5. Bid Selected</strong>
                        <br><small>By sender</small>
                    </div>
                    <span class="flow-arrow">‚Üí</span>
                    <div class="flow-step active">
                        <strong>6. Deliver</strong>
                        <br><small>Optimized route</small>
                    </div>
                </div>
            </div>

            <div class="note">
                <strong>Note:</strong> The system evolved from simple accept/decline to a bidding system. Couriers now place bids on matched packages, and senders choose the winning bid. This allows for price negotiation and better matching.
            </div>
        </section>

        <section>
            <h2>Database Models</h2>

            <h3>CourierRoute Table</h3>
            <table>
                <thead>
                    <tr>
                        <th>Column</th>
                        <th>Type</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>id</code></td>
                        <td>Integer (PK)</td>
                        <td>Primary key</td>
                    </tr>
                    <tr>
                        <td><code>courier_id</code></td>
                        <td>Integer (FK)</td>
                        <td>Foreign key to users</td>
                    </tr>
                    <tr>
                        <td><code>start_address</code></td>
                        <td>String</td>
                        <td>Starting address text</td>
                    </tr>
                    <tr>
                        <td><code>start_lat</code></td>
                        <td>Float</td>
                        <td>Starting latitude (-90 to 90)</td>
                    </tr>
                    <tr>
                        <td><code>start_lng</code></td>
                        <td>Float</td>
                        <td>Starting longitude (-180 to 180)</td>
                    </tr>
                    <tr>
                        <td><code>end_address</code></td>
                        <td>String</td>
                        <td>Ending address text</td>
                    </tr>
                    <tr>
                        <td><code>end_lat</code></td>
                        <td>Float</td>
                        <td>Ending latitude</td>
                    </tr>
                    <tr>
                        <td><code>end_lng</code></td>
                        <td>Float</td>
                        <td>Ending longitude</td>
                    </tr>
                    <tr>
                        <td><code>max_deviation_km</code></td>
                        <td>Integer</td>
                        <td>Maximum deviation from route (1-50 km, default 5)</td>
                    </tr>
                    <tr>
                        <td><code>departure_time</code></td>
                        <td>DateTime</td>
                        <td>Optional departure timestamp</td>
                    </tr>
                    <tr>
                        <td><code>trip_date</code></td>
                        <td>DateTime</td>
                        <td>Optional trip date (route expires after)</td>
                    </tr>
                    <tr>
                        <td><code>is_active</code></td>
                        <td>Boolean</td>
                        <td>Only one active route per courier</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section>
            <h2>Configuration</h2>

            <table class="config-table">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Default</th>
                        <th>Range</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>max_deviation_km</code></td>
                        <td>5</td>
                        <td>1-50</td>
                        <td>How far packages can deviate from direct route</td>
                    </tr>
                    <tr>
                        <td><code>departure_time</code></td>
                        <td>null</td>
                        <td>DateTime</td>
                        <td>Optional planned departure time</td>
                    </tr>
                    <tr>
                        <td><code>trip_date</code></td>
                        <td>null</td>
                        <td>Date</td>
                        <td>Optional expiration date for route</td>
                    </tr>
                    <tr>
                        <td><code>notify_hours_threshold</code></td>
                        <td>24</td>
                        <td>1+</td>
                        <td>Hours before re-notifying about same package</td>
                    </tr>
                </tbody>
            </table>

            <h3>Business Rules</h3>
            <ul style="margin-left: 20px; margin-top: 15px;">
                <li>Only <code>OPEN_FOR_BIDS</code> packages are matched</li>
                <li>Only active, non-expired routes can match</li>
                <li>One active route per courier at a time</li>
                <li>New route automatically deactivates old routes</li>
                <li>Cannot create route while having active deliveries</li>
                <li>Packages sorted by detour distance (shortest first)</li>
                <li>Inactive packages (<code>is_active=False</code>) are skipped</li>
            </ul>
        </section>

        <section>
            <h2>File Structure</h2>

            <div class="file-tree">
<span class="folder">backend/</span>
‚îú‚îÄ‚îÄ <span class="folder">app/routes/</span>
‚îÇ   ‚îú‚îÄ‚îÄ <span class="file">matching.py</span> <span class="desc"># Matching API endpoints</span>
‚îÇ   ‚îî‚îÄ‚îÄ <span class="file">couriers.py</span> <span class="desc"># Route CRUD endpoints</span>
‚îú‚îÄ‚îÄ <span class="folder">app/services/</span>
‚îÇ   ‚îú‚îÄ‚îÄ <span class="file">matching_job.py</span> <span class="desc"># Background matching job</span>
‚îÇ   ‚îú‚îÄ‚îÄ <span class="file">route_optimizer.py</span> <span class="desc"># Delivery stop ordering</span>
‚îÇ   ‚îî‚îÄ‚îÄ <span class="file">route_deactivation_service.py</span> <span class="desc"># Route cleanup</span>
‚îú‚îÄ‚îÄ <span class="folder">app/models/</span>
‚îÇ   ‚îî‚îÄ‚îÄ <span class="file">package.py</span> <span class="desc"># CourierRoute & Package models</span>
‚îú‚îÄ‚îÄ <span class="folder">app/utils/</span>
‚îÇ   ‚îî‚îÄ‚îÄ <span class="file">geo.py</span> <span class="desc"># Haversine distance calculation</span>
‚îî‚îÄ‚îÄ <span class="folder">tests/</span>
    ‚îú‚îÄ‚îÄ <span class="file">test_matching.py</span> <span class="desc"># Algorithm tests</span>
    ‚îî‚îÄ‚îÄ <span class="file">test_matching_job.py</span> <span class="desc"># Background job tests</span>

<span class="folder">frontend/</span>
‚îú‚îÄ‚îÄ <span class="folder">app/[locale]/courier/routes/</span>
‚îÇ   ‚îú‚îÄ‚îÄ <span class="folder">create/</span>
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ <span class="file">page.tsx</span> <span class="desc"># Route creation form</span>
‚îÇ   ‚îî‚îÄ‚îÄ <span class="folder">[id]/matches/</span>
‚îÇ       ‚îî‚îÄ‚îÄ <span class="file">page.tsx</span> <span class="desc"># Matching packages list</span>
‚îú‚îÄ‚îÄ <span class="folder">lib/</span>
‚îÇ   ‚îî‚îÄ‚îÄ <span class="file">api.ts</span> <span class="desc"># matchingAPI, couriersAPI</span>
‚îî‚îÄ‚îÄ <span class="folder">components/</span>
    ‚îî‚îÄ‚îÄ <span class="file">BidOptionsModal.tsx</span> <span class="desc"># Bid placement modal</span>
            </div>
        </section>

        <section>
            <h2>Example Workflow</h2>

            <div class="workflow-example">
                <h4>Complete Matching Flow Example</h4>

                <p><strong>Step 1:</strong> Courier creates route (San Francisco ‚Üí San Jose, 10km deviation)</p>
                <div class="code-block">
<span class="keyword">POST</span> /api/couriers/routes
{
  <span class="string">"start_address"</span>: <span class="string">"San Francisco, CA"</span>,
  <span class="string">"start_lat"</span>: <span class="number">37.7749</span>,
  <span class="string">"start_lng"</span>: <span class="number">-122.4194</span>,
  <span class="string">"end_address"</span>: <span class="string">"San Jose, CA"</span>,
  <span class="string">"end_lat"</span>: <span class="number">37.3382</span>,
  <span class="string">"end_lng"</span>: <span class="number">-121.8863</span>,
  <span class="string">"max_deviation_km"</span>: <span class="number">10</span>
}
                </div>

                <p><strong>Step 2:</strong> Backend automatically matches packages along route</p>

                <p><strong>Step 3:</strong> Courier views matches</p>
                <div class="code-block">
<span class="keyword">GET</span> /api/matching/packages-along-route/1

<span class="comment">// Returns packages sorted by detour:</span>
<span class="comment">// - Palo Alto package: 3.2 km detour</span>
<span class="comment">// - Mountain View package: 5.1 km detour</span>
                </div>

                <p><strong>Step 4:</strong> Courier places bid on best package</p>
                <div class="code-block">
<span class="keyword">POST</span> /api/bids
{
  <span class="string">"package_id"</span>: <span class="number">15</span>,
  <span class="string">"proposed_price"</span>: <span class="number">20.00</span>,
  <span class="string">"route_id"</span>: <span class="number">1</span>
}
                </div>

                <p><strong>Step 5:</strong> After bid selection, courier gets optimized route</p>
                <div class="code-block">
<span class="keyword">GET</span> /api/matching/optimized-route/1

<span class="comment">// Returns ordered delivery stops:</span>
<span class="comment">// 1. Pickup: Palo Alto</span>
<span class="comment">// 2. Dropoff: Mountain View</span>
<span class="comment">// 3. Pickup: Another package...</span>
                </div>
            </div>
        </section>

        <section>
            <h2>Background Matching Job</h2>

            <p>The matching job runs periodically to notify couriers about new packages matching their active routes.</p>

            <h3>Running the Job</h3>
            <div class="code-block">
<span class="comment"># Dry run (no notifications created)</span>
python -m app.services.matching_job --dry-run --hours 24

<span class="comment"># Production run</span>
python -m app.services.matching_job --hours 24
            </div>

            <h3>Job Features</h3>
            <ul style="margin-left: 20px; margin-top: 15px;">
                <li><strong>Spam Prevention:</strong> Won't re-notify about same package within 24 hours (configurable)</li>
                <li><strong>Active Routes Only:</strong> Only processes active, non-expired routes</li>
                <li><strong>Notification Creation:</strong> Creates in-app notifications for matched packages</li>
                <li><strong>Dry Run Mode:</strong> Test mode that shows what would be notified without creating notifications</li>
            </ul>
        </section>

        <footer>
            <p>Chaski - Route-Package Matching Documentation</p>
            <p>Last updated: December 2025</p>
            <p><a href="MATCHING_API.md">View API Documentation (Markdown)</a></p>
        </footer>
    </div>
</body>
</html>
